

== Gradle S2I builder based on UBI-8
We'll show how to build a Spring app



----
As our S2I builder uses UBI-8,
we need to get a registry token from https://access.redhat.com/terms-based-registry/

Example: my username is xxxx|marcsecret


oc create secret docker-registry marcsecret \
    --docker-server=registry.redhat.io \
    --docker-username="xxxx|marcsecret" \
    --docker-password="" \
    --docker-email=mchisine@redhat.com

oc secrets link default marcsecret --for=pull
 
oc secrets link builder marcsecret
----


----
oc adm policy add-cluster-role-to-user cluster-admin system:serviceaccount:camel-pipelines:builder
----

----
oc edit scc restricted
readOnlyRootFilesystem: false
----

----
oc import-image centos:8 --confirm
imagestream.image.openshift.io/centos imported
----

----
oc new-build https://github.com/marcredhat/handy-environment --name gradle-container
----

----
oc get build
NAME                 TYPE     FROM   STATUS    STARTED   DURATION
gradle-container-1   Docker   Git    Pending
----

----
oc logs build/gradle-container-1 --follow
.....
Successfully pushed image-registry.openshift-image-registry.svc:5000/camel-pipelines/gradle-container@sha256:d53aa09f88a6fddce47341f92f68437b5206b61114453c6a7efc5fe16931a8f7
Push successful
----


----
In the command below, "complete" is the folder where the build.gradle file is found at https://github.com/spring-guides/gs-gradle.git
----

----
oc new-app --loglevel=6 gradle-container~https://github.com/spring-guides/gs-gradle.git --context-dir=complete
--> Found image d0af529 (3 minutes old) in image stream "camel-pipelines/gradle-container" under tag "latest" for "gradle-container"

    Handy Environment
    -----------------
    S2I builder for Java Applications.

    Tags: builder, java, maven, gradle

    * A source build using source code from https://github.com/spring-guides/gs-gradle.git will be created
      * The resulting image will be pushed to image stream tag "gs-gradle:latest"
      * Use 'oc start-build' to trigger a new build
    * This image will be deployed in deployment config "gs-gradle"
    * Port 8080/tcp will be load balanced by service "gs-gradle"
      * Other containers can access this service through the hostname "gs-gradle"

--> Creating resources ...
    imagestream.image.openshift.io "gs-gradle" created
    buildconfig.build.openshift.io "gs-gradle" created
    deploymentconfig.apps.openshift.io "gs-gradle" created
    service "gs-gradle" created
--> Success
    Build scheduled, use 'oc logs -f bc/gs-gradle' to track its progress.
    Application is not exposed. You can expose services to the outside world by executing one or more of the commands below:
     'oc expose svc/gs-gradle'
    Run 'oc status' to view your app.
----


----
....
STEP 7: RUN /home/s2i/bin/assemble
[BUILDER-INFO] Installing application source...
[BUILDER-INFO] gradle build detected
[BUILDER-INFO] gradle build

Welcome to Gradle 6.2.2!

Here are the highlights of this release:
 - Dependency checksum and signature verification
 - Shareable read-only dependency cache
 - Documentation links in deprecation messages

For more details see https://docs.gradle.org/6.2.2/release-notes.html

Starting a Gradle Daemon (subsequent builds will be faster)
> Task :compileJava
> Task :processResources NO-SOURCE
> Task :classes
> Task :jar
> Task :startScripts
> Task :distTar
> Task :distZip
> Task :assemble
> Task :compileTestJava
> Task :processTestResources NO-SOURCE
> Task :testClasses
> Task :test
> Task :check
> Task :build



BUILD SUCCESSFUL in 15s
7 actionable tasks: 7 executed
[BUILDER-INFO] gradle run
> Task :compileJava UP-TO-DATE
> Task :processResources NO-SOURCE
> Task :classes UP-TO-DATE

> Task :run
The current local time is: 18:08:20.250
Hello world!


BUILD SUCCESSFUL in 2s
2 actionable tasks: 1 executed, 1 up-to-date
STEP 8: CMD /home/s2i/bin/run
STEP 9: COMMIT temp.builder.openshift.io/camel-pipelines/gs-gradle-1:68613f32
....
----

----
Cleanup
oc delete imagestreamtag.image.openshift.io "gs-gradle:latest"
oc delete buildconfigs.build.openshift.io "gs-gradle"
oc delete deploymentconfigs.apps.openshift.io "gs-gradle"
oc delete svc gs-gradle
----

