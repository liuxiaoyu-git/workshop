
----
See https://kubernetes.io/docs/tutorials/stateful-application/basic-stateful-set/
We are going to create an Nginx Stateful Set using the storage class created by the Local Storage Operator (marcsc).

oc create -f https://raw.githubusercontent.com/marcredhat/workshop/master/localstorageoperator/nginx_stateful_set_using_the_storage_class_created_by_local_storage_operator.yaml
----

----
for i in 0 1; do kubectl exec web-$i -- sh -c 'echo $(hostname) > /usr/share/nginx/html/index.html'; done

for i in 0 1; do kubectl exec -it web-$i -- curl localhost; done
web-0
web-1
----


----
kubectl delete pod -l app=nginx
----


----
for i in 0 1; do kubectl exec -it web-$i -- curl localhost; done
web-0
web-1
----

----
Even though web-0 and web-1 were rescheduled, they continue to serve their hostnames 
because the PersistentVolumes associated with their PersistentVolumeClaims are remounted to their volumeMounts. 
No matter what node web-0and web-1 are scheduled on, 
their PersistentVolumes will be mounted to the appropriate mount points.
----


----
Default Kubernetes service type is ClusterIP.

oc get svc | grep nginx
nginx                    ClusterIP      None             <none>        80/TCP                                          156m

With ClusterIP None, no load-balancing is done and no cluster IP is allocated for this service. 
Only DNS is automatically configured. 
When you run a DNS query for headless service, you will get the list of the Pods IPs.
Usually, the client DNS chooses the first DNS record.
----


----
Let's created a DaemonSet with DNS tools.
We'll connect to one of pods and run a DNS query for the headless service
----

----          
oc create -f https://raw.githubusercontent.com/marcredhat/workshop/master/localstorageoperator/dnstoolsdaemonset.yaml
oc label node worker-1.ocp43.local dnstools=dnstools-node
oc label node worker-2.ocp43.local dnstools=dnstools-node

oc rsh dnstools-rsdxs
#
# host nginx
nginx.camel-pipelines.svc.cluster.local has address 10.128.3.65
nginx.camel-pipelines.svc.cluster.local has address 10.129.1.104
----



----
kubectl run -i --tty --image busybox:1.28 dns-test --restart=Never --rm   nslookup web-0.nginx

Server:    172.30.0.10
Address 1: 172.30.0.10 dns-default.openshift-dns.svc.cluster.local

Name:      web-0.nginx
Address 1: 10.128.3.35 web-0.nginx.camel-pipelines.svc.cluster.local
pod "dns-test" deleted
----

